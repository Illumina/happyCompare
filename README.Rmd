---
title: "happyCompare"
output:
  github_document:
    toc: true
    toc_depth: 4
---

```{r include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

# Description

A reporting toolbox for happy output.


# Usage

```{r message=FALSE}
library(happyCompare)
```

## Interactive analyses

### Load data into R

We can easily load the results from set of hap.py outputs by creating a happyCompare samplesheet, e.g.:

```
Group.Id,Sample.Id,Replicate.Id,happy_prefix
freebayes,NA12878,NA12878_freebayes,output/freebayes
gatk,NA12878,NA12878_gatk,output/gatk
platypus,NA12878,NA12878_platypus,output/platypus
```

Then importing its contents into R:

```{r eval=FALSE}
## do not run
happy_compare = read_samplesheet(samplesheet_path = "happyCompare/happyCompare_samplesheet.csv")
```
```{r message=FALSE}
# use pre-saved dataset from now on
load("data/happy_compare.RData")
```

The resulting `happy_compare` object contains the following fields:

- `samplesheet`: the original samplesheet
- `happy_results`: a list of `happy_result` objects as defined in `happyR`, with identifiers automatically set from samplesheet details


We can further explore the contents of `happy_compare` as we would with any other list, e.g.:

```{r message=FALSE}
names(happy_compare)
names(happy_compare$happy_results)
names(happy_compare$happy_results[[1]])
```

Alternatively, we can use `read_samplesheet_()` to create a `happy_compare` from its components:

```{r}
# re-use from pre-loaded dataset
happy_results <- happy_compare$happy_results
  
# modify samplesheet
samplesheet <- happy_compare$samplesheet %>% 
  mutate(Group.Id = "Single group") %>% 
  select(Group.Id, Sample.Id, Replicate.Id, happy_prefix)
samplesheet

# set ids
ids <- samplesheet %>% 
  mutate(.Id = paste(Group.Id, Sample.Id, Replicate.Id, sep = "-")) %>% 
  select(.Id) %>% 
  unlist()

# store as a new happy_compare
custom_hcl <- read_samplesheet_(samplesheet = samplesheet, 
                               happy_results = happy_results,
                               ids = ids)
class(custom_hcl)
```

### Extract tables of metrics

The method `extract()` provides quick access to the nested results within our `happy_compare`, whilst preserving samplesheet metadata:

```{r}
# inspect our object
names(happy_compare$happy_results[[1]])
sapply(happy_compare$happy_results[[1]], class)
names(happy_compare$happy_results[[1]]$pr_curve)

# extract a table with hap.py summary metrics
summary <- extract(happy_compare, table = "summary")
str(summary)

# extract a table with hap.py roc metrics
roc <- extract(happy_compare, table = "pr_curve.SNP_PASS")
class(roc)
names(roc) %>% head(n = 12)
```

From here, we can continue the analysis with custom R functions or by using the reporting modules provided.

### Reporting modules

#### Obtain a summary of performance metrics

We can use the method `tabulate()` to display a summary of performance metrics as a formatted table, e.g.:

```{r}
cols <- c("Group.Id", "Replicate.Id", "METRIC.Recall", "METRIC.Precision", "METRIC.Frac_NA", "METRIC.F1_Score")
colnames <- c("Group.Id", "Sample", "Recall", "Precision", "Frac_NA", "F1_Score")

# 1 replicate per group
s <- extract(happy_compare, table = "summary")
t <- tabulate(happy_summary = s, cols = cols, colnames = colnames, 
             filter = "PASS", vartype = "SNP", aggregate = FALSE)
t %>% knitr::kable()

# multiple replicates
s <- extract(custom_hcl, table = "summary")
t <- tabulate(happy_summary = s, cols = cols, colnames = colnames, 
             filter = "PASS", vartype = "SNP", aggregate = TRUE)
t %>% knitr::kable()
```


#### Plot a ROC curve for precision vs recall

We can visualise precision-recall ROC curves by passing `happy_roc` objects to `plot()`:

```{r message=FALSE, fig.width=15, fig.height=5}
roc <- extract(happy_compare, table = "pr_curve.all")
class(roc)

p1 <- plot(roc, type = "SNP", filter = "ALL")  
p2 <- plot(roc, type = "SNP", filter = "PASS")
p3 <- plot(roc, type = "SNP", filter = "SEL")

ggplot2::theme_set(theme_bw())
gridExtra::grid.arrange(p1, p2, p3, nrow = 1)
```

The plots above display one ROC curve per replicate, colored by group. The PASS point is also highlighted. Note how in the first plot, which displays ALL SNPs, the PASS point for the blue dataset does not overlap with the ALL ROC curve, as emphasised by the connector line that links it to the end of the ROC curve.

## Static reports

Coming soon.

# Demo datasets

## `happy_compare`

A demo `happy_compare` object, obtained by running hap.py on hap.py example data and loading the results into R using `happyCompare::read_samplesheet()`.

**Step 1: run hap.py**

```
$HAPPY_ROOT=/path/to/hap.py/repo/root
$HAPPY_BIN=/path/to/hap.py/binnary

# fixed hap.py resources
truth=$HAPPY_ROOT/example/happy/PG_NA12878_hg38-chr21.vcf.gz
conf=$HAPPY_ROOT/example/happy/PG_Conf_hg38-chr21.bed.gz
ref=$HAPPY_ROOT/example/happy/hg38.chr21.fa

# query VCFs
gatk_q=$HAPPY_ROOT/example/happy/NA12878-GATK3-chr21.vcf.gz
freebayes_q=$HAPPY_ROOT/example/happy/NA12878-Freebayes-chr21.vcf.gz
platypus_q=$HAPPY_ROOT/example/happy/NA12878-Platypus-chr21.vcf.gz

# run hap.py
mkdir -p $outdir
$HAPPY_BIN -f $conf -r $ref --no-json $truth $gatk_q --roc-filter LowQual --roc QUAL -o $outdir/gatk
$HAPPY_BIN -f $conf -r $ref --no-json $truth $freebayes_q --roc-filter LowQual --roc QUAL -o $outdir/freebayes
$HAPPY_BIN -f $conf -r $ref --no-json $truth $platypus_q --roc QUAL -o $outdir/platypus
```

**Step 2: Create a happyCompare samplesheet**

```
Group.Id,Sample.Id,Replicate.Id,happy_prefix
freebayes,NA12878,NA12878_freebayes,output/freebayes
gatk,NA12878,NA12878_gatk,output/gatk
platypus,NA12878,NA12878_platypus,output/platypus
```

**Step 3: Load data into R**

```{r message=FALSE, eval = FALSE}
library(happyCompare)

happy_compare <- read_samplesheet(samplesheet_path = "happyCompare/happyCompare_samplesheet.csv")
save(happy_compare, file = "happyCompare/happy_compare.RData")
```
